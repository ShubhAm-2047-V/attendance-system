<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mark Attendance | AttendEase</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="dashboard-bg admin-page page-enter">

<div class="admin-container">

    <div class="attendance-card glass-card">

        <!-- Header -->
        <div class="attendance-header">
            <h2>Mark Attendance</h2>
            <p>Select attendance status for students</p>
        </div>

        <!-- Progress -->
        <div id="progress-text" class="progress-text"></div>

        <!-- Student name -->
        <div id="student-name" class="student-name"></div>

        <!-- Buttons -->
        <div class="status-options" id="action-buttons">
            <button class="pill present" onclick="submitAttendance('Present')">
                ‚úî Present
            </button>
            <button class="pill absent" onclick="submitAttendance('Absent')">
                ‚úñ Absent
            </button>
        </div>

        <!-- Done Section -->
        <div id="done-msg" class="done-msg hidden">

            <div class="done-title">
                ‚úÖ All students marked
            </div>

            <!-- Chart -->
            <div class="chart-wrap">
                <canvas id="attendanceChart" width="220" height="220"></canvas>
            </div>

            <!-- Absent list -->
            <div class="absent-section">
                <h4>Absent Students</h4>
                <ol id="absent-list"></ol>
            </div>

            <!-- Exit -->
            <a href="/teacher" class="exit-btn">
                ‚Üê Exit to Dashboard
            </a>
        </div>

    </div>

</div>

<script>
const students = [
    {% for s in students %}
        "{{ s.username }}",
    {% endfor %}
];

let currentIndex = 0;
let presentCount = 0;
let absentCount = 0;
let absentStudents = [];
let locked = false;

const nameBox = document.getElementById("student-name");
const progressBox = document.getElementById("progress-text");
const doneMsg = document.getElementById("done-msg");
const buttons = document.getElementById("action-buttons");
const absentList = document.getElementById("absent-list");

function showStudent() {
    if (students.length === 0) {
        nameBox.innerText = "No students found";
        progressBox.innerText = "";
        buttons.style.display = "none";
        return;
    }

    if (currentIndex < students.length) {
        nameBox.innerText = students[currentIndex];
        progressBox.innerText = `Student ${currentIndex + 1} / ${students.length}`;
    } else {
        nameBox.style.display = "none";
        buttons.style.display = "none";
        progressBox.style.display = "none";
        doneMsg.classList.remove("hidden");
        showChart();
        showAbsentList();
    }
}

function submitAttendance(status) {
    if (locked) return;
    locked = true;

    fetch("/mark_single", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `student=${students[currentIndex]}&status=${status}`
    }).then(res => {
        locked = false;

        if (!res.ok) return;

        if (status === "Present") {
            presentCount++;
        } else {
            absentCount++;
            absentStudents.push(students[currentIndex]);
        }

        currentIndex++;
        showStudent();
    });
}

function showChart() {
    const ctx = document.getElementById("attendanceChart").getContext("2d");
    new Chart(ctx, {
        type: "pie",
        data: {
            labels: ["Present", "Absent"],
            datasets: [{
                data: [presentCount, absentCount],
                backgroundColor: ["#22c55e", "#ef4444"]
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: "bottom",
                    labels: { color: "#0f172a" }
                }
            }
        }
    });
}

function showAbsentList() {
    absentList.innerHTML = "";
    if (absentStudents.length === 0) {
        absentList.innerHTML = "<li>No absent students üéâ</li>";
    } else {
        absentStudents.forEach(name => {
            const li = document.createElement("li");
            li.textContent = name;
            absentList.appendChild(li);
        });
    }
}

// init
showStudent();
</script>

</body>
</html>
